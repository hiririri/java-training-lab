<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç»ƒä¹ 4ï¼šå¤§å°å†™äº¤æ›¿ Â· åŠ¨æ€æ¼”ç¤º</title>
<style>
  :root{
    --box:64px;            /* æ¯ä¸ªå­—ç¬¦æ–¹å—çš„å°ºå¯¸ */
    --gap:12px;            /* æ–¹å—é—´è· */
  }
  body{
    font-family: "Segoe UI","PingFang SC","Microsoft Yahei",system-ui,-apple-system,sans-serif;
    background:#f6f7fb; color:#222; margin:0; padding:24px;
  }
  h1{ margin:0 0 12px; font-size:20px; }
  .card{ background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); padding:16px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  input[type=text]{ padding:10px 12px; border:1px solid #ddd; border-radius:8px; min-width:240px; font-size:16px; }
  button{
    padding:10px 14px; border:0; border-radius:10px; cursor:pointer; font-size:14px;
    background:#2b6cff; color:#fff;
  }
  button.ghost{ background:#eef2ff; color:#2b6cff; }
  button:disabled{ opacity:.6; cursor:not-allowed; }
  .board-wrap{ margin-top:18px; overflow-x:auto; padding-bottom:8px; }
  .board{
    display:flex; align-items:flex-start; gap:var(--gap); position:relative; padding:12px 0 38px;
    min-height: calc(var(--box) + 46px);
  }
  .cell{
    width:var(--box); height:var(--box); border-radius:14px; border:2px solid #d9dff0;
    background:#fff; display:flex; align-items:center; justify-content:center;
    font-size:26px; font-weight:600; position:relative; flex:0 0 auto;
  }
  .cell.dim{ opacity:.35; }
  .cell.active{ border-color:#2b6cff; background:#eef2ff; }
  .cell.processed{ border-color:#10b981; background:#ecfdf5; }
  .cell.uppercase{ border-color:#f59e0b; background:#fef3c7; }
  .cell.lowercase{ border-color:#8b5cf6; background:#f3e8ff; }
  .index{
    position:absolute; bottom:-28px; left:0; width:100%; text-align:center; font-size:12px; color:#667;
  }
  .ascii{
    position:absolute; top:-28px; left:0; width:100%; text-align:center; font-size:11px; color:#2b6cff; font-weight:600;
  }
  .pattern{
    position:absolute; top:-50px; left:0; width:100%; text-align:center; font-size:10px; color:#ef4444; font-weight:600;
  }
  /* æŒ‡é’ˆç®­å¤´ */
  .pointer{
    position:absolute; top:-30px; width:0; height:0; border-left:10px solid transparent;
    border-right:10px solid transparent; border-bottom:12px solid #2b6cff; transition:transform .25s ease;
  }
  .pointer-label{
    position:absolute; top:-50px; transform:translateX(-50%); background:#2b6cff; color:#fff;
    padding:2px 8px; border-radius:999px; font-size:12px; white-space:nowrap;
  }
  .status{ margin-top:16px; line-height:1.9; }
  code{ background:#f1f3fb; border-radius:6px; padding:2px 6px; }
  .steps{ 
    margin-top:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
    white-space:pre-wrap; height:400px; overflow-y:auto; padding:12px; 
    background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;
    font-size:13px; line-height:1.4;
  }
  .steps::-webkit-scrollbar {
    width: 8px;
  }
  .steps::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }
  .steps::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
  }
  .steps::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .flex-layout {
      flex-direction: column !important;
    }
    .flex-layout > div:last-child {
      border-left: none !important;
      padding-left: 0 !important;
      border-top: 2px solid #e2e8f0;
      padding-top: 20px;
      margin-top: 20px;
    }
    .steps {
      height: 250px !important;
    }
  }
  .muted{ color:#6b7280; }
  .code-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-left: 8px;
  }
  .code-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  .code-display {
    margin-top: 16px;
    padding: 16px;
    background: #1e293b;
    border-radius: 8px;
    border: 1px solid #334155;
    display: none;
  }
  .code-display pre {
    color: #e2e8f0;
    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
    margin: 0;
    white-space: pre-wrap;
  }
  .code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #334155;
  }
  .code-title {
    color: #f1f5f9;
    font-weight: 600;
    font-size: 14px;
  }
  .copy-btn {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .copy-btn:hover {
    background: #2563eb;
  }
  .result{ 
    margin-top:16px; padding:12px; background:#f0f9ff; border-radius:8px; border-left:4px solid #2b6cff;
    font-size:18px; font-weight:600; color:#1e40af;
  }
  .calculation{
    margin-top:8px; font-size:14px; color:#374151;
  }
</style>
</head>
<body>

<h1>ç»ƒä¹ 4ï¼šå¤§å°å†™äº¤æ›¿ï¼ˆåŠ¨æ€è¿‡ç¨‹ï¼‰</h1>

<div class="card">
  <div class="row">
    <input id="txt" type="text" placeholder="ä¾‹å¦‚ï¼šhello" />
    <div style="font-size:12px; color:#666; margin-top:4px;">
      è¯•è¯•è¿™äº›ä¾‹å­ï¼šhello(HeLlO), world(WoRlD), example(ExAmPlE), test(TeSt)
    </div>
    <button id="start">å¼€å§‹</button>
    <button id="step" class="ghost" disabled>ä¸‹ä¸€æ­¥</button>
    <button id="auto" class="ghost" disabled>è‡ªåŠ¨æ’­æ”¾</button>
    <button id="clear" class="ghost">æ¸…ç©ºæ—¥å¿—</button>
    <button id="reset" class="ghost" disabled>é‡ç½®</button>
    <button id="showCode" class="code-btn">æ˜¾ç¤ºJavaä»£ç ç­”æ¡ˆ</button>
  </div>

  <!-- å·¦å³åˆ†æ å¸ƒå±€ -->
  <div class="flex-layout" style="display:flex; gap:20px; margin-top:18px;">
    <!-- å·¦ä¾§ï¼šå¯è§†åŒ–æ¼”ç¤º -->
    <div style="flex:1;">
      <div class="board-wrap">
        <div id="board" class="board">
          <!-- åŠ¨æ€æ³¨å…¥ï¼šæ–¹å— + æŒ‡é’ˆ -->
        </div>
      </div>

      <div class="status">
        <div>é•¿åº¦ï¼š<code id="len">-</code>ï¼Œåˆå§‹åŒ–ï¼š<code>int i = 0, result = "", shouldUpper = true</code></div>
        <div>å½“å‰ä½ç½®ï¼š<code id="pos">-</code>ï¼Œå½“å‰å­—ç¬¦ï¼š<code id="cur">-</code></div>
        <div>å½“å‰æ¨¡å¼ï¼š<code id="mode">-</code>ï¼Œç´¯è®¡ç»“æœï¼š<code id="result">""</code></div>
        <div class="muted">è½¬æ¢è§„åˆ™ï¼š<code>if (shouldUpper) ch = toupper(ch); else ch = tolower(ch); shouldUpper = !shouldUpper;</code></div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šæ‰§è¡Œæ—¥å¿— -->
    <div style="flex:1; border-left:2px solid #e2e8f0; padding-left:20px;">
      <div style="font-weight:600; color:#374151; margin-bottom:8px;">ğŸ“ æ‰§è¡Œæ—¥å¿—ï¼š</div>
      <div class="steps" id="log"></div>
    </div>
  </div>

  <div class="explanation" style="margin-top:16px; padding:12px; background:#f8fafc; border-radius:8px; border-left:4px solid #3b82f6;">
    <div style="font-weight:600; color:#1e40af; margin-bottom:8px;">ğŸ’¡ ä¸ºä»€ä¹ˆè¦ç”¨è¿™ä¸ªç®—æ³•ï¼Ÿ</div>
    <div style="font-size:14px; line-height:1.6; color:#374151;">
      <div><strong>ğŸ”„ å¤§å°å†™äº¤æ›¿çš„åŸç†ï¼š</strong></div>
      <div style="margin:6px 0;">â€¢ äº¤æ›¿æ¨¡å¼å°±æ˜¯å¤§å†™å’Œå°å†™å­—æ¯è½®æµå‡ºç°</div>
      <div style="margin:6px 0;">â€¢ ä¾‹å¦‚ï¼šhello â†’ HeLlOï¼ˆç¬¬1ä¸ªå­—æ¯å¤§å†™ï¼Œç¬¬2ä¸ªå­—æ¯å°å†™ï¼Œä»¥æ­¤ç±»æ¨ï¼‰</div>
      
      <div style="margin:8px 0; padding:8px; background:#fff; border-radius:6px; font-family:monospace;">
        <div style="text-align:center; margin-bottom:4px;"><strong>äº¤æ›¿æ¨¡å¼ï¼ˆä»¥helloä¸ºä¾‹ï¼‰</strong></div>
        <div style="display:flex; justify-content:space-around; text-align:center;">
          <div>åŸå­—ç¬¦: h e l l o</div>
        </div>
        <div style="display:flex; justify-content:space-around; text-align:center; color:#2b6cff;">
          <div>ä½ç½®: 0 1 2 3 4</div>
        </div>
        <div style="display:flex; justify-content:space-around; text-align:center; color:#10b981;">
          <div>æ¨¡å¼: å¤§ å° å¤§ å° å¤§</div>
        </div>
        <div style="display:flex; justify-content:space-around; text-align:center; color:#ef4444;">
          <div>ç»“æœ: H e L l O</div>
        </div>
        <div style="text-align:center; margin-top:4px; color:#f59e0b;">
          è§„å¾‹: å¶æ•°ä½ç½®(0,2,4...)å¤§å†™ï¼Œå¥‡æ•°ä½ç½®(1,3,5...)å°å†™
        </div>
      </div>
      
      <div style="margin:12px 0 6px 0;"><strong>ğŸ§® ç®—æ³•åŸç†ï¼š</strong></div>
      <div style="margin:6px 0;">â€¢ ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”å˜é‡è®°å½•å½“å‰åº”è¯¥ç”¨å¤§å†™è¿˜æ˜¯å°å†™</div>
      <div style="margin:6px 0;">â€¢ ä»å·¦åˆ°å³éå†æ¯ä¸ªå­—ç¬¦</div>
      <div style="margin:6px 0;">â€¢ æ ¹æ®å½“å‰ä½ç½®å†³å®šè½¬æ¢æ–¹å‘ï¼Œç„¶ååˆ‡æ¢æ¨¡å¼</div>
      
      <div style="margin:12px 0 6px 0;"><strong>ğŸ¯ ä¸ºä»€ä¹ˆç”¨å¸ƒå°”å˜é‡ï¼Ÿ</strong></div>
      <div style="margin:6px 0;">â€¢ å¸ƒå°”å˜é‡å¯ä»¥ç®€å•åœ°åœ¨true/falseä¹‹é—´åˆ‡æ¢</div>
      <div style="margin:6px 0;">â€¢ trueè¡¨ç¤ºåº”è¯¥è½¬æ¢ä¸ºå¤§å†™ï¼Œfalseè¡¨ç¤ºåº”è¯¥è½¬æ¢ä¸ºå°å†™</div>
      <div style="margin:6px 0;">â€¢ æ¯å¤„ç†ä¸€ä¸ªå­—ç¬¦åï¼Œç”¨!æ“ä½œç¬¦åˆ‡æ¢çŠ¶æ€</div>
    </div>
  </div>
  
  <div id="finalResult" class="result" style="display:none;">
    <div>æœ€ç»ˆç»“æœï¼š<span id="alternatingValue">-</span></div>
    <div class="calculation" id="calculation"></div>
  </div>

  <!-- Javaä»£ç ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ -->
  <div id="codeDisplay" class="code-display">
    <div class="code-header">
      <div class="code-title">ğŸ“ Javaä»£ç ç­”æ¡ˆ - å¤§å°å†™äº¤æ›¿</div>
      <button class="copy-btn" onclick="copyCode()">å¤åˆ¶ä»£ç </button>
    </div>
    <pre id="javaCode">
    public static void exercice4() {
      Scanner sc = new Scanner(System.in);
      System.out.print("è¯·è¾“å…¥å­—ç¬¦ä¸²: ");
      String s = sc.nextLine();

      String result = "";
      boolean shouldUpper = true; // true è¡¨ç¤ºè¯¥ä½ç½®è¦ç”¨å¤§å†™ï¼Œfalse è¡¨ç¤ºå°å†™

      // éå†å­—ç¬¦ä¸²
      for (int i = 0; i < s.length(); i++) {
          char ch = s.charAt(i);

          if (shouldUpper) {
              // å½“å‰è¯¥å¤§å†™
              if (ch >= 'a' && ch <= 'z') {
                  ch = (char)(ch - 32); // è½¬å¤§å†™
              }
          } else {
              // å½“å‰è¯¥å°å†™
              if (ch >= 'A' && ch <= 'Z') {
                  ch = (char)(ch + 32); // è½¬å°å†™
              }
          }

          result += ch;           // æ‹¼æ¥ç»“æœ
          shouldUpper = !shouldUpper; // æ¯æ¬¡åˆ‡æ¢çŠ¶æ€
      }

      System.out.println("åŸå­—ç¬¦ä¸²: " + s);
      System.out.println("äº¤æ›¿å: " + result);
    }
    </pre>
  </div>
</div>

<script>
  const $ = sel => document.querySelector(sel);
  const txt = $('#txt'), startBtn = $('#start'), stepBtn = $('#step'),
        autoBtn = $('#auto'), clearBtn = $('#clear'), resetBtn = $('#reset'),
        showCodeBtn = $('#showCode'), codeDisplay = $('#codeDisplay'),
        board = $('#board'), lenOut = $('#len'), posOut = $('#pos'),
        curOut = $('#cur'), modeOut = $('#mode'), resultOut = $('#result'),
        log = $('#log'), finalResult = $('#finalResult'),
        alternatingValue = $('#alternatingValue'), calculation = $('#calculation');

  let s = "", i = 0, result = "", shouldUpper = true, timer = null;

  function clearBoard(){
    board.innerHTML = "";
  }

  function renderBoard(){
    clearBoard();
    // æŒ‡é’ˆ
    const pointer = document.createElement('div');
    pointer.className = 'pointer';
    const plabel = document.createElement('div');
    plabel.className = 'pointer-label';
    plabel.textContent = 'i';
    board.appendChild(pointer);
    board.appendChild(plabel);

    // æ–¹å—
    for (let k=0; k<s.length; k++){
      const div = document.createElement('div');
      div.className = 'cell';
      if (k < i) div.classList.add('processed');
      else if (k === i) div.classList.add('active');
      div.dataset.idx = k;
      const ch = s[k];
      const ascii = ch.charCodeAt(0);
      const isEven = k % 2 === 0;
      div.innerHTML = `
        <span>${ch}</span>
        <div class="index">${k}</div>
        <div class="ascii">${ascii}</div>
        <div class="pattern">${isEven ? 'å¤§' : 'å°'}</div>
      `;
      board.appendChild(div);
    }

    // å®šä½æŒ‡é’ˆåˆ°ç¬¬ i ä¸ªæ–¹å—ä¸Šæ–¹
    movePointer();
  }

  function movePointer(){
    const pointer = board.querySelector('.pointer');
    const label = board.querySelector('.pointer-label');
    if (i >= s.length) {
      // ç§»åˆ°æœ€å³ä¾§ä¹‹å¤–
      const lastCell = board.querySelector('.cell:last-child');
      if (lastCell) {
        const rect = lastCell.getBoundingClientRect();
        const boardRect = board.getBoundingClientRect();
        const centerX = rect.left - boardRect.left + rect.width/2 + 76; // 76 = gap + box width
        pointer.style.transform = `translateX(${centerX - 10}px)`;
        label.style.left = `${centerX}px`;
      }
      return;
    }
    const target = Array.from(board.querySelectorAll('.cell')).find(c => +c.dataset.idx === i);
    if (!target) return;
    const rect = target.getBoundingClientRect();
    const boardRect = board.getBoundingClientRect();
    // æŒ‡é’ˆæ°´å¹³å±…ä¸­äºç›®æ ‡ cell
    const centerX = rect.left - boardRect.left + rect.width/2;
    pointer.style.transform = `translateX(${centerX - 10}px)`;
    label.style.left = `${centerX}px`;
  }

  function setButtons(running){
    stepBtn.disabled = !running;
    autoBtn.disabled = !running;
    resetBtn.disabled = !running;
  }

  function printLog(line, addTimestamp = false){
    const timestamp = addTimestamp ? `[${new Date().toLocaleTimeString()}] ` : '';
    log.textContent += timestamp + line + '\n';
    // ç¡®ä¿æ—¥å¿—åŒºåŸŸæ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
      log.scrollTop = log.scrollHeight;
    }, 10);
  }

  function printExplanation(step, ch, ascii, shouldUpper, newCh, newAscii){
    let explanation = `æ­¥éª¤ ${step}: å¤„ç†å­—ç¬¦ s[${step-1}]='${ch}'\n`;
    explanation += `  â€¢ ASCIIå€¼ï¼š${ascii}\n`;
    explanation += `  â€¢ å½“å‰ä½ç½®ï¼š${step-1}ï¼ˆ${(step-1) % 2 === 0 ? 'å¶æ•°' : 'å¥‡æ•°'}ä½ç½®ï¼‰\n`;
    explanation += `  â€¢ å½“å‰æ¨¡å¼ï¼š${shouldUpper ? 'å¤§å†™' : 'å°å†™'}\n`;
    
    if (shouldUpper) {
      if (ch >= 'a' && ch <= 'z') {
        explanation += `  â€¢ è½¬æ¢ï¼š'${ch}' (${ascii}) - 32 = '${newCh}' (${newAscii})\n`;
        explanation += `  â€¢ ç®—æ³•ï¼šch = ch - 'a' + 'A' = ${ascii} - 97 + 65 = ${newAscii}\n`;
      } else {
        explanation += `  â€¢ å­—ç¬¦å·²æ˜¯å¤§å†™ï¼Œä¿æŒä¸å˜ï¼š'${ch}'\n`;
      }
    } else {
      if (ch >= 'A' && ch <= 'Z') {
        explanation += `  â€¢ è½¬æ¢ï¼š'${ch}' (${ascii}) + 32 = '${newCh}' (${newAscii})\n`;
        explanation += `  â€¢ ç®—æ³•ï¼šch = ch - 'A' + 'a' = ${ascii} - 65 + 97 = ${newAscii}\n`;
      } else {
        explanation += `  â€¢ å­—ç¬¦å·²æ˜¯å°å†™ï¼Œä¿æŒä¸å˜ï¼š'${ch}'\n`;
      }
    }
    
    explanation += `  â€¢ æ·»åŠ åˆ°ç»“æœï¼šresult += '${newCh}'\n`;
    explanation += `  â€¢ åˆ‡æ¢æ¨¡å¼ï¼šshouldUpper = ${shouldUpper} â†’ ${!shouldUpper}\n`;
    
    printLog(explanation);
  }

  function stepOnce(){
    if (i < s.length){
      const ch = s[i];
      const ascii = ch.charCodeAt(0);
      let newCh = ch;
      let newAscii = ascii;
      
      if (shouldUpper) {
        // åº”è¯¥è½¬æ¢ä¸ºå¤§å†™
        if (ch >= 'a' && ch <= 'z') {
          newCh = String.fromCharCode(ascii - 32);
          newAscii = ascii - 32;
        }
      } else {
        // åº”è¯¥è½¬æ¢ä¸ºå°å†™
        if (ch >= 'A' && ch <= 'Z') {
          newCh = String.fromCharCode(ascii + 32);
          newAscii = ascii + 32;
        }
      }
      
      result += newCh;
      
      // è§†è§‰ï¼šå½“å‰å¤„ç†çš„ cell å˜ç»¿
      const current = board.querySelector(`.cell[data-idx="${i}"]`);
      if (current) {
        current.classList.remove('active');
        current.classList.add('processed');
        if (shouldUpper) {
          current.classList.add('uppercase');
        } else {
          current.classList.add('lowercase');
        }
        // æ›´æ–°æ˜¾ç¤ºçš„å­—ç¬¦
        if (newCh !== ch) {
          current.querySelector('span').textContent = newCh;
          current.querySelector('.ascii').textContent = newAscii;
        }
      }

      // ä½¿ç”¨æ–°çš„è¯¦ç»†è§£é‡Šå‡½æ•°
      printExplanation(i + 1, ch, ascii, shouldUpper, newCh, newAscii);
      
      // åˆ‡æ¢æ¨¡å¼
      shouldUpper = !shouldUpper;
      i++;
      
      lenOut.textContent = s.length;
      posOut.textContent = i;
      curOut.textContent = (i < s.length ? s[i] : 'â€”');
      modeOut.textContent = (i < s.length ? (shouldUpper ? 'å¤§å†™' : 'å°å†™') : 'â€”');
      resultOut.textContent = `"${result}"`;
      movePointer();
      
      // æ›´æ–°ä¸‹ä¸€ä¸ªcellä¸ºactive
      if (i < s.length) {
        const next = board.querySelector(`.cell[data-idx="${i}"]`);
        if (next) next.classList.add('active');
      }
    } else {
      // å®Œæˆ
      printLog(`\nğŸ‰ å®Œæˆï¼æœ€ç»ˆç»“æœ = "${result}"`);
      printLog(`\nğŸ“š æ€»ç»“ï¼š`);
      printLog(`â€¢ æˆ‘ä»¬ä½¿ç”¨ç®—æ³•ï¼šif (shouldUpper) ch = toupper(ch); else ch = tolower(ch); shouldUpper = !shouldUpper`);
      printLog(`â€¢ è¿™ä¸ªç®—æ³•çš„åŸç†æ˜¯ï¼šç”¨å¸ƒå°”å˜é‡æ§åˆ¶å¤§å°å†™è½¬æ¢çš„æ–¹å‘`);
      printLog(`â€¢ æ¯å¤„ç†ä¸€ä¸ªå­—ç¬¦ååˆ‡æ¢æ¨¡å¼ï¼Œå®ç°å¤§å°å†™äº¤æ›¿`);
      
      stepBtn.disabled = true;
      autoBtn.textContent = 'è‡ªåŠ¨æ’­æ”¾';
      if (timer){ clearInterval(timer); timer=null; }
      
      // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
      finalResult.style.display = 'block';
      alternatingValue.textContent = result;
      
      // æ˜¾ç¤ºè½¬æ¢è¿‡ç¨‹
      let calcText = '';
      let tempShouldUpper = true;
      for (let k = 0; k < s.length; k++) {
        const ch = s[k];
        let newCh = ch;
        
        if (tempShouldUpper) {
          if (ch >= 'a' && ch <= 'z') {
            newCh = String.fromCharCode(ch.charCodeAt(0) - 32);
          }
        } else {
          if (ch >= 'A' && ch <= 'Z') {
            newCh = String.fromCharCode(ch.charCodeAt(0) + 32);
          }
        }
        
        if (calcText) calcText += ' + ';
        calcText += `'${ch}'â†’'${newCh}'`;
        tempShouldUpper = !tempShouldUpper;
      }
      calcText += ` = "${result}"`;
      calculation.textContent = calcText;
    }
  }

  startBtn.addEventListener('click', ()=>{
    s = (txt.value ?? "").toString().trim();
    if (!s.length){ alert('è¯·è¾“å…¥è¦è½¬æ¢çš„å­—ç¬¦ä¸²'); return; }
    
    i = 0; result = ""; shouldUpper = true; log.textContent = "";
    lenOut.textContent = s.length; 
    posOut.textContent = i; 
    curOut.textContent = s[i]; 
    modeOut.textContent = 'å¤§å†™';
    resultOut.textContent = '""';
    finalResult.style.display = 'none';
    
    renderBoard();
    setButtons(true);
    stepBtn.focus();
    printLog(`ğŸš€ å¼€å§‹è½¬æ¢å­—ç¬¦ä¸² "${s}" ä¸ºå¤§å°å†™äº¤æ›¿`);
    printLog(`ğŸ“‹ åˆå§‹åŒ–ï¼š`);
    printLog(`  â€¢ å­—ç¬¦ä¸²é•¿åº¦ï¼š${s.length}`);
    printLog(`  â€¢ ä»æœ€å·¦è¾¹å¼€å§‹ï¼ši=0`);
    printLog(`  â€¢ åˆå§‹æ¨¡å¼ï¼šshouldUpper=trueï¼ˆå¤§å†™ï¼‰`);
    printLog(`  â€¢ åˆå§‹ç»“æœï¼šresult=""`);
    printLog(`  â€¢ è½¬æ¢è§„åˆ™ï¼šif (shouldUpper) ch = toupper(ch); else ch = tolower(ch); shouldUpper = !shouldUpper`);
    printLog(`\nå¼€å§‹é€æ­¥è½¬æ¢ï¼š`);
  });

  stepBtn.addEventListener('click', stepOnce);

  clearBtn.addEventListener('click', ()=>{
    log.textContent = '';
  });

  showCodeBtn.addEventListener('click', ()=>{
    if (codeDisplay.style.display === 'none' || codeDisplay.style.display === '') {
      codeDisplay.style.display = 'block';
      showCodeBtn.textContent = 'éšè—Javaä»£ç ';
      showCodeBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    } else {
      codeDisplay.style.display = 'none';
      showCodeBtn.textContent = 'æ˜¾ç¤ºJavaä»£ç ç­”æ¡ˆ';
      showCodeBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
  });

  // å¤åˆ¶ä»£ç åŠŸèƒ½
  window.copyCode = function() {
    const codeText = document.getElementById('javaCode').textContent;
    navigator.clipboard.writeText(codeText).then(() => {
      const copyBtn = document.querySelector('.copy-btn');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'å·²å¤åˆ¶!';
      copyBtn.style.background = '#10b981';
      setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.style.background = '#3b82f6';
      }, 2000);
    }).catch(err => {
      console.error('å¤åˆ¶å¤±è´¥:', err);
      alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä»£ç å¤åˆ¶');
    });
  };

  autoBtn.addEventListener('click', ()=>{
    if (!timer){
      autoBtn.textContent = 'æš‚åœ';
      timer = setInterval(()=>{
        if (i >= s.length){ clearInterval(timer); timer=null; autoBtn.textContent='è‡ªåŠ¨æ’­æ”¾'; return; }
        stepOnce();
      }, 800);
    } else {
      clearInterval(timer); timer=null;
      autoBtn.textContent = 'è‡ªåŠ¨æ’­æ”¾';
    }
  });

  resetBtn.addEventListener('click', ()=>{
    if (timer){ clearInterval(timer); timer=null; autoBtn.textContent='è‡ªåŠ¨æ’­æ”¾'; }
    s=""; i=0; result=""; shouldUpper=true; txt.value="";
    lenOut.textContent = posOut.textContent = curOut.textContent = modeOut.textContent = '-';
    resultOut.textContent = '""'; log.textContent = "";
    finalResult.style.display = 'none';
    clearBoard(); setButtons(false);
  });

  // è®©çª—å£å˜åŒ–æ—¶æŒ‡é’ˆé‡æ–°å®šä½
  window.addEventListener('resize', movePointer);
</script>
</body>
</html>
